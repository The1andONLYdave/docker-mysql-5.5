language: python
python:
  - 2.7

###
### Add services
###
services:
  - docker


###
### Global variables
###
env:
  global:
    - MY_DOCKER_NAME="my-db-docker"
    - MY_MYSQL_PASS="toor"


###
### Install
###
install:

  - mkdir -p /tmp/mysql-log
  - mkdir -p /tmp/mysql-sock
  - mkdir -p /tmp/mysql-conf

  - chmod -R 777 /tmp/mysql-log
  - chmod -R 777 /tmp/mysql-sock
  - chmod -R 777 /tmp/mysql-conf

  - docker version

  # Build my docker
  - docker build -t cytopia/${MY_DOCKER_NAME} .



###
### Test
###
script:

  ##
  ## 01.) [a](DEBUG) Test plain docker
  ##
  - docker run
      -p 127.0.0.1:3306:3306
      -e DEBUG_COMPOSE_ENTRYPOINT=1
      -e MYSQL_ROOT_PASSWORD=${MY_MYSQL_PASS}
      --name ${MY_DOCKER_NAME} cytopia/${MY_DOCKER_NAME} &
  - sleep 15

  - docker ps

  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW DATABASES;"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';"


  - docker stop "$( docker ps | grep  "${MY_DOCKER_NAME}" | awk '{print $1}' )"
  - docker rm "${MY_DOCKER_NAME}"
  ##
  ## 01.) [b](SILENT) Test plain docker
  ##
  - docker run
      -p 127.0.0.1:3306:3306
      -e MYSQL_ROOT_PASSWORD=${MY_MYSQL_PASS}
      --name ${MY_DOCKER_NAME} cytopia/${MY_DOCKER_NAME} &
  - sleep 15

  - docker ps

  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW DATABASES;"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';"

  - docker stop "$( docker ps | grep  "${MY_DOCKER_NAME}" | awk '{print $1}' )"
  - docker rm "${MY_DOCKER_NAME}"



  ##
  ## 02.) [a](DEBUG) With logging
  ##
  - docker run
      -p 127.0.0.1:3306:3306
      -v /tmp/mysql-log:/var/log/mysql
      -e DEBUG_COMPOSE_ENTRYPOINT=1
      -e MYSQL_GENERAL_LOG=1
      -e MYSQL_ROOT_PASSWORD=${MY_MYSQL_PASS}
      --name ${MY_DOCKER_NAME} cytopia/${MY_DOCKER_NAME} &
  - sleep 15

  - docker ps

  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW DATABASES;"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';"

  # Validate log file
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';" | grep 'ON'

  - ls -la /tmp/mysql-log
  - cat /tmp/mysql-log/error.log
  - cat /tmp/mysql-log/mysql.log

  - docker stop "$( docker ps | grep  "${MY_DOCKER_NAME}" | awk '{print $1}' )"
  - docker rm "${MY_DOCKER_NAME}"
  ##
  ## 02.) [a](SILENT) With logging
  ##
  - docker run
      -p 127.0.0.1:3306:3306
      -v /tmp/mysql-log:/var/log/mysql
      -e MYSQL_GENERAL_LOG=1
      -e MYSQL_ROOT_PASSWORD=${MY_MYSQL_PASS}
      --name ${MY_DOCKER_NAME} cytopia/${MY_DOCKER_NAME} &
  - sleep 15

  - docker ps

  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW DATABASES;"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';"

  # Validate log file
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';" | grep 'ON'

  - ls -la /tmp/mysql-log
  - cat /tmp/mysql-log/*

  - docker stop "$( docker ps | grep  "${MY_DOCKER_NAME}" | awk '{print $1}' )"
  - docker rm "${MY_DOCKER_NAME}"




  ##
  ## 03.) [a](DEBUG) With config overwrite
  ##
  - printf "[mysqld]\n%s\n" "key_buffer = 500M" > /tmp/mysql-conf/buffer.cnf

  - docker run
      -p 127.0.0.1:3306:3306
      -v /tmp/mysql-conf:/etc/mysql/conf.d
      -e DEBUG_COMPOSE_ENTRYPOINT=1
      -e MYSQL_ROOT_PASSWORD=${MY_MYSQL_PASS}
      --name ${MY_DOCKER_NAME} cytopia/${MY_DOCKER_NAME} &
  - sleep 15

  - docker ps

  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW DATABASES;"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';"

  # Validate configuration file
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';" | grep '524288000'

  - docker stop "$( docker ps | grep  "${MY_DOCKER_NAME}" | awk '{print $1}' )"
  - docker rm "${MY_DOCKER_NAME}"
  ##
  ## 03.) [a](SILENT) With config overwrite
  ##
  - printf "[mysqld]\n%s\n" "key_buffer = 500M" > /tmp/mysql-conf/buffer.cnf

  - docker run
      -p 127.0.0.1:3306:3306
      -v /tmp/mysql-conf:/etc/mysql/conf.d
      -e MYSQL_ROOT_PASSWORD=${MY_MYSQL_PASS}
      --name ${MY_DOCKER_NAME} cytopia/${MY_DOCKER_NAME} &
  - sleep 15

  - docker ps

  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW DATABASES;"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%general%log%';"
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';"

  # Validate configuration file
  - mysql --user=root --password=${MY_MYSQL_PASS} --host=127.0.0.1 -e "SHOW VARIABLES WHERE Variable_name LIKE '%key%buffer%';" | grep '524288000'

  - docker stop "$( docker ps | grep  "${MY_DOCKER_NAME}" | awk '{print $1}' )"
  - docker rm "${MY_DOCKER_NAME}"
